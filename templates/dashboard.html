{% extends "layout.html" %}
{% block content %}

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card p-3 d-flex flex-row align-items-center justify-content-between">
            <div>
                <span class="text-muted d-block text-uppercase small ls-1">Tiền mặt khả dụng</span>
                <h4 class="mb-0 fw-bold">{{ "{:,.0f}".format(user.balance) }} <small class="fs-6 text-muted">VND</small></h4>
            </div>
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 text-primary">
                <i class="fas fa-money-bill-wave fa-lg"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 d-flex flex-row align-items-center justify-content-between">
            <div>
                <span class="text-muted d-block text-uppercase small ls-1">Giá trị chứng khoán</span>
                <h4 class="mb-0 fw-bold" id="total-stock-value">Loading...</h4>
            </div>
            <div class="rounded-circle bg-info bg-opacity-10 p-3 text-info">
                <i class="fas fa-layer-group fa-lg"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 d-flex flex-row align-items-center justify-content-between">
            <div>
                <span class="text-muted d-block text-uppercase small ls-1">Tổng tài sản ròng</span>
                <h4 class="mb-0 fw-bold text-warning" id="net-worth">Loading...</h4>
            </div>
            <div class="rounded-circle bg-warning bg-opacity-10 p-3 text-warning">
                <i class="fas fa-chart-pie fa-lg"></i>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center border-0 pt-3 px-4">
                <h5 class="mb-0"><i class="fas fa-globe text-primary me-2"></i>Thị Trường</h5>
                <span class="badge bg-dark border border-secondary fw-normal" id="last-update">
                    <i class="fas fa-sync fa-spin me-1"></i> Loading...
                </span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">Mã CK</th>
                                <th class="text-end">Giá Khớp</th>
                                <th class="text-end">Thay Đổi</th>
                                <th class="text-center">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for symbol in watchlist %}
                            <tr id="market-row-{{ symbol }}">
                                <td class="ps-4"><span class="fw-bold fs-5">{{ symbol }}</span></td>
                                <td class="text-end price-cell fw-bold fs-5">...</td>
                                <td class="text-end change-cell">...</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-success rounded-pill px-3" onclick="fillOrder('{{symbol}}', 'buy')">
                                        <i class="fas fa-plus"></i> Mua
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header border-0 pt-3 px-4">
                <h5 class="mb-0"><i class="fas fa-briefcase text-success me-2"></i>Danh Mục Sở Hữu</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">Mã</th>
                                <th class="text-end">KL</th>
                                <th class="text-end">Giá TB</th>
                                <th class="text-end">Thị Giá</th>
                                <th class="text-end">Lãi/Lỗ</th>
                                <th class="text-center">Chốt</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in user.portfolio %}
                            <tr class="portfolio-item" data-symbol="{{ item.symbol }}" data-qty="{{ item.quantity }}" data-avg="{{ item.average_price }}">
                                <td class="ps-4 fw-bold text-primary">{{ item.symbol }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(item.quantity) }}</td>
                                <td class="text-end text-muted small">{{ "{:,.0f}".format(item.average_price) }}</td>
                                <td class="text-end fw-bold" id="port-market-price-{{ item.symbol }}">...</td>
                                <td class="text-end fw-bold" id="port-pnl-{{ item.symbol }}">...</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-danger rounded-pill px-3" onclick="fillOrder('{{item.symbol}}', 'sell')">
                                        Bán
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="text-center py-4 text-muted">Chưa có cổ phiếu nào</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card position-sticky" style="top: 20px;">
            <div class="card-header bg-primary text-white border-0 py-3">
                <h5 class="mb-0 text-center"><i class="fas fa-paper-plane me-2"></i>Đặt Lệnh</h5>
            </div>
            <div class="card-body">
                <form action="/trade" method="POST">
                    <div class="mb-3">
                        <label class="form-label text-muted small text-uppercase">Mã Chứng Khoán</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-light"><i class="fas fa-search"></i></span>
                            <input type="text" id="trade-symbol" name="symbol" class="form-control fw-bold text-uppercase fs-5" placeholder="VD: HPG" required>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <input type="radio" class="btn-check" name="action" id="buy-opt" value="buy" checked>
                            <label class="btn btn-outline-success w-100 py-2 fw-bold" for="buy-opt">
                                <i class="fas fa-arrow-down me-1"></i> MUA
                            </label>
                        </div>
                        <div class="col-6">
                            <input type="radio" class="btn-check" name="action" id="sell-opt" value="sell">
                            <label class="btn btn-outline-danger w-100 py-2 fw-bold" for="sell-opt">
                                <i class="fas fa-arrow-up me-1"></i> BÁN
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-muted small text-uppercase">Khối Lượng</label>
                        <input type="number" name="quantity" class="form-control fs-5" min="10" step="10" value="100" required>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold fs-5 shadow">
                        GỬI LỆNH
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Config
    const currentBalance = {{ user.balance }};
    let watchSymbols = {{ watchlist | tojson }};
    
    // --- JS LOGIC ---
    function fillOrder(symbol, action) {
        document.getElementById('trade-symbol').value = symbol;
        if(action === 'buy') document.getElementById('buy-opt').click();
        else document.getElementById('sell-opt').click();
        
        // Animation scroll lên top phải
        document.getElementById('trade-symbol').scrollIntoView({behavior: "smooth", block: "center"});
        document.getElementById('trade-symbol').focus();
    }

    // Auto add portfolio items to watchlist array
    document.querySelectorAll('.portfolio-item').forEach(item => {
        let sym = item.getAttribute('data-symbol');
        if (!watchSymbols.includes(sym)) watchSymbols.push(sym);
    });

    async function updateMarketData() {
        const now = new Date();
        document.getElementById('last-update').innerText = now.toLocaleTimeString();

        let totalStockValue = 0;

        for (const symbol of watchSymbols) {
            try {
                const res = await fetch(`/api/price/${symbol}`);
                const data = await res.json();
                
                if (data.error) continue;

                const price = data.price;
                const change = data.change;
                const percent = data.percent || 0;

                // 1. Update Watchlist Table
                const marketRow = document.getElementById(`market-row-${symbol}`);
                if (marketRow) {
                    const priceCell = marketRow.querySelector('.price-cell');
                    const changeCell = marketRow.querySelector('.change-cell');

                    const colorClass = change > 0 ? 'text-up' : (change < 0 ? 'text-down' : 'text-ref');
                    const icon = change > 0 ? '▲' : (change < 0 ? '▼' : '');
                    
                    priceCell.innerHTML = `<span class="${colorClass}">${price.toLocaleString('vi-VN')}</span>`;
                    changeCell.innerHTML = `<span class="${colorClass}">${icon} ${change.toLocaleString('vi-VN')} <small>(${percent}%)</small></span>`;
                }

                // 2. Update Portfolio & Calculate Total Assets
                const portRow = document.querySelector(`.portfolio-item[data-symbol="${symbol}"]`);
                if (portRow) {
                    const qty = parseFloat(portRow.getAttribute('data-qty'));
                    const avgPrice = parseFloat(portRow.getAttribute('data-avg'));
                    
                    const marketVal = price * qty;
                    totalStockValue += marketVal;
                    
                    const pnl = (price - avgPrice) * qty;
                    const pnlPercent = ((price - avgPrice) / avgPrice) * 100;
                    const pnlClass = pnl >= 0 ? 'text-up' : 'text-down';
                    
                    document.getElementById(`port-market-price-${symbol}`).innerText = price.toLocaleString('vi-VN');
                    document.getElementById(`port-pnl-${symbol}`).innerHTML = 
                        `<span class="${pnlClass} fw-bold">${pnl.toLocaleString('vi-VN')} <br> <small style="font-size:0.8em">(${pnlPercent.toFixed(1)}%)</small></span>`;
                }

            } catch (err) {
                console.error(err);
            }
        }

        // 3. Update Top Widgets
        document.getElementById('total-stock-value').innerText = totalStockValue.toLocaleString('vi-VN') + ' ₫';
        
        const totalNetWorth = currentBalance + totalStockValue;
        document.getElementById('net-worth').innerText = totalNetWorth.toLocaleString('vi-VN') + ' ₫';
    }

    // Init loop
    updateMarketData();
    setInterval(updateMarketData, 5000);
</script>
{% endblock %}