{% extends "base.html" %}
{% block title %}{{ symbol }} - Chi tiết cổ phiếu{% endblock %}

{% block content %}
<style>
  /* CSS cho Legend (Bảng thông số khi di chuột) */
  .chart-legend {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 2;
    font-family: 'Roboto', sans-serif;
    font-size: 12px;
    line-height: 18px;
    font-weight: 500;
    color: #d1d4dc;
    pointer-events: none;
    /* Để chuột xuyên qua không bị vướng */
  }

  .legend-item {
    display: flex;
    gap: 8px;
  }

  .legend-label {
    opacity: 0.7;
  }

  .legend-value {
    font-weight: bold;
  }
</style>

<div class="container-fluid p-0">
  <div class="row g-0" style="height: calc(100vh - 50px)">

    <div class="col-md-9 border-end border-secondary position-relative d-flex flex-column">

      <div class="chart-header p-2 d-flex align-items-center gap-4 px-4"
        style="background: #131722; border-bottom: 1px solid #2a2e39; height: 50px;">
        <h4 class="m-0 fw-bold text-warning">{{ symbol }}</h4>

        <div class="d-flex align-items-end gap-2">
          <span class="text-white fs-4 fw-bold lh-1">{{ "{:,.0f}".format(current) }}</span>
          <span class="fs-6 text-muted mb-1">VNĐ</span>
        </div>

        {% if history and history|length > 1 %}
        {% set change = current - history[-1].close %}
        {% set pct = (change / history[-1].close) * 100 %}
        <div class="{{ 'text-success' if change >= 0 else 'text-danger' }} d-flex align-items-center gap-2 fw-bold">
          <span class="fs-5">{{ "{:+,.0f}".format(change) }}</span>
          <span
            class="badge {{ 'bg-success' if change >= 0 else 'bg-danger' }} bg-opacity-25 text-white border {{ 'border-success' if change >= 0 else 'border-danger' }}">
            {{ "{:+.2f}%".format(pct) }}
          </span>
        </div>
        {% endif %}
      </div>

      <div id="chart-container" style="width: 100%; flex-grow: 1; position: relative;">
        <div id="tv-chart"></div>

        <div class="chart-legend" id="chart-legend">
          <div class="legend-item text-white fs-6 mb-1">{{ symbol }}</div>
          <div class="legend-item">
            <span class="text-success">O: <span id="leg-open">--</span></span>
            <span class="text-danger">H: <span id="leg-high">--</span></span>
            <span class="text-info">L: <span id="leg-low">--</span></span>
            <span class="text-warning">C: <span id="leg-close">--</span></span>
          </div>
          <div class="legend-item mt-1">
            <span style="color: #768f40">Vol: <span id="leg-vol">--</span></span>
          </div>
          <div class="legend-item">
            <span style="color: #2962FF">MA10: <span id="leg-ma10">--</span></span>
            <span style="color: #F48FB1; margin-left: 8px;">MA30: <span id="leg-ma30">--</span></span>
          </div>
        </div>

        <div id="chart-loader" class="position-absolute top-50 start-50 translate-middle text-center">
          <div class="spinner-border text-warning" role="status"></div>
          <div class="text-muted small mt-2">Đang tải dữ liệu {{ symbol }}...</div>
        </div>
      </div>
    </div>

    <div class="col-md-3 bg-dark-panel d-flex flex-column" style="background: #1e222d;">
      <div class="p-3 flex-grow-1">
        <h5 class="text-white mb-3 text-uppercase border-bottom border-secondary pb-2">Đặt Lệnh</h5>
        <form action="/trade" method="post" id="tradeForm">
          <input type="hidden" name="symbol" value="{{ symbol }}" />

          <div class="d-flex justify-content-between mb-3 p-2 rounded bg-dark border border-secondary">
            <span class="text-secondary small">Sức mua:</span>
            <span class="text-warning fw-bold">{{ "{:,.0f}".format(current_user.balance) }} ₫</span>
          </div>

          <div class="mb-3">
            <label class="text-secondary small mb-1">Giá thị trường</label>
            <input type="text" class="form-control bg-dark border-secondary text-white fw-bold"
              value="{{ '{:,.0f}'.format(current) }}" readonly />
          </div>

          <div class="mb-3">
            <label class="text-secondary small mb-1">Khối lượng (Lô 100)</label>
            <div class="input-group">
              <button type="button" class="btn btn-outline-secondary" onclick="adjustQty(-100)">-</button>
              <input type="number" name="quantity" id="qtyInput"
                class="form-control bg-dark border-secondary text-white text-center fw-bold" placeholder="0" step="100"
                min="100" required oninput="calcTotal()" />
              <button type="button" class="btn btn-outline-secondary" onclick="adjustQty(100)">+</button>
            </div>
          </div>

          <div class="mb-4 d-flex justify-content-between gap-1">
            <button type="button" onclick="setQtyPercent(0.25)"
              class="btn btn-sm btn-outline-secondary flex-fill">25%</button>
            <button type="button" onclick="setQtyPercent(0.5)"
              class="btn btn-sm btn-outline-secondary flex-fill">50%</button>
            <button type="button" onclick="setQtyPercent(0.75)"
              class="btn btn-sm btn-outline-secondary flex-fill">75%</button>
            <button type="button" onclick="setQtyPercent(1)"
              class="btn btn-sm btn-outline-secondary flex-fill">All</button>
          </div>

          <div
            class="d-flex justify-content-between align-items-center mb-4 p-3 rounded bg-black bg-opacity-25 border border-secondary">
            <span class="text-secondary small">Tổng giá trị:</span>
            <span class="fs-5 fw-bold text-white" id="totalVal">0 ₫</span>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" name="action" value="buy"
              class="btn btn-success py-3 fw-bold text-uppercase shadow">MUA {{ symbol }}</button>
            <button type="submit" name="action" value="sell"
              class="btn btn-danger py-3 fw-bold text-uppercase shadow">BÁN {{ symbol }}</button>
          </div>
        </form>
      </div>

      <div class="p-3 border-top border-secondary text-center">
        <a href="{{ url_for('market.market') }}" class="text-decoration-none text-info small"><i
            class="bi bi-arrow-left"></i> Quay lại</a>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<script>
  // ==========================================
  // 1. HÀM TÍNH TOÁN SMA (Moving Average)
  // ==========================================
  function calculateSMA(data, count) {
    var avg = function (data) {
      var sum = 0;
      var c = 0;
      for (var i = 0; i < data.length; i++) {
        sum += data[i].close;
        c++;
      }
      return sum / c;
    };
    var result = [];
    for (var i = count - 1; i < data.length; i++) {
      var val = avg(data.slice(i - count + 1, i + 1));
      result.push({ time: data[i].time, value: val });
    }
    return result;
  }

  // ==========================================
  // 2. KHỞI TẠO CHART
  // ==========================================
  const container = document.getElementById('tv-chart');
  const loader = document.getElementById('chart-loader');

  // Set chiều cao cha để chart fill hết
  container.style.height = "100%";
  if (container.clientHeight === 0) container.style.height = "500px";

  const chart = LightweightCharts.createChart(container, {
    layout: { textColor: '#d1d4dc', background: { type: 'solid', color: '#131722' } },
    grid: { vertLines: { color: '#2a2e39', style: 1 }, horzLines: { color: '#2a2e39', style: 1 } },
    rightPriceScale: {
      visible: true,
      scaleMargins: { top: 0.1, bottom: 0.2 }, // Chừa 20% đáy cho Volume
      borderColor: '#2a2e39',
    },
    timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#2a2e39', rightOffset: 5 },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal, // Cho phép di chuột mượt
    },
    // Watermark: Tên mã chứng khoán chìm
    watermark: {
      visible: true,
      fontSize: 60,
      horzAlign: 'center',
      vertAlign: 'center',
      color: 'rgba(255, 255, 255, 0.05)',
      text: '{{ symbol }}',
    },
  });

  // Series 1: Nến
  const candlestickSeries = chart.addCandlestickSeries({
    upColor: '#089981', downColor: '#f23645',
    borderVisible: false, wickUpColor: '#089981', wickDownColor: '#f23645',
  });

  // Series 2: Volume (Overlay)
  const volumeSeries = chart.addHistogramSeries({
    color: '#26a69a',
    priceFormat: { type: 'volume' },
    priceScaleId: '',
  });
  chart.priceScale('').applyOptions({
    scaleMargins: { top: 0.75, bottom: 0 },
  });

  // Series 3: MA10 (Màu xanh dương)
  const ma10Series = chart.addLineSeries({
    color: '#2962FF',
    lineWidth: 1,
    crosshairMarkerVisible: false,
    lastValueVisible: false, // Ẩn label ở trục giá cho đỡ rối
    priceLineVisible: false,
  });

  // Series 4: MA30 (Màu hồng/đỏ nhạt)
  const ma30Series = chart.addLineSeries({
    color: '#F48FB1',
    lineWidth: 2,
    crosshairMarkerVisible: false,
    lastValueVisible: true,
    priceLineVisible: false,
  });

  // ==========================================
  // 3. XỬ LÝ DỮ LIỆU
  // ==========================================
  let rawData = {{ history | tojson }};

  if (rawData && rawData.length > 0) {
    if (loader) loader.style.display = 'none';

    let candles = [];
    let volumes = [];

    rawData.forEach(d => {
      // Fix Date
      let timeStr = d.date;
      if (timeStr && timeStr.includes('/')) {
        let parts = timeStr.split('/');
        if (parts.length === 3) timeStr = `${parts[2]}-${parts[1]}-${parts[0]}`;
      }

      let volValue = Number(d.volume);
      if (isNaN(volValue)) volValue = 0;

      const isUp = d.close >= d.open;
      const volColor = isUp ? 'rgba(8, 153, 129, 0.5)' : 'rgba(242, 54, 69, 0.5)';

      candles.push({ time: timeStr, open: d.open, high: d.high, low: d.low, close: d.close });
      volumes.push({ time: timeStr, value: volValue, color: volColor });
    });

    // Sort
    candles.sort((a, b) => new Date(a.time) - new Date(b.time));
    volumes.sort((a, b) => new Date(a.time) - new Date(b.time));

    // Tính toán MA
    const ma10Data = calculateSMA(candles, 10);
    const ma30Data = calculateSMA(candles, 30);

    // Đổ dữ liệu vào Chart
    candlestickSeries.setData(candles);
    volumeSeries.setData(volumes);
    ma10Series.setData(ma10Data);
    ma30Series.setData(ma30Data);

    chart.timeScale().fitContent();

    // ==========================================
    // 4. CẬP NHẬT LEGEND KHI DI CHUỘT
    // ==========================================
    const legendIds = {
      open: document.getElementById('leg-open'),
      high: document.getElementById('leg-high'),
      low: document.getElementById('leg-low'),
      close: document.getElementById('leg-close'),
      vol: document.getElementById('leg-vol'),
      ma10: document.getElementById('leg-ma10'),
      ma30: document.getElementById('leg-ma30'),
    };

    chart.subscribeCrosshairMove(param => {
      if (param.time) {
        // Lấy dữ liệu tại điểm crosshair
        const candleData = param.seriesData.get(candlestickSeries);
        const volData = param.seriesData.get(volumeSeries);
        const ma10Val = param.seriesData.get(ma10Series);
        const ma30Val = param.seriesData.get(ma30Series);

        if (candleData) {
          legendIds.open.innerText = candleData.open.toLocaleString();
          legendIds.high.innerText = candleData.high.toLocaleString();
          legendIds.low.innerText = candleData.low.toLocaleString();
          legendIds.close.innerText = candleData.close.toLocaleString();
          // Đổi màu close theo tăng giảm
          legendIds.close.style.color = (candleData.close >= candleData.open) ? '#089981' : '#f23645';
        }
        if (volData) legendIds.vol.innerText = volData.value.toLocaleString();

        // MA có thể undefined nếu chuột ở vùng chưa đủ dữ liệu tính MA
        legendIds.ma10.innerText = ma10Val ? ma10Val.value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '--';
        legendIds.ma30.innerText = ma30Val ? ma30Val.value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '--';
      }
    });

  } else {
    console.error("Không có dữ liệu history");
    if (loader) loader.innerHTML = '<div class="text-danger">Không có dữ liệu biểu đồ</div>';
  }

  // Auto resize
  window.addEventListener('resize', () => {
    chart.resize(container.clientWidth, container.clientHeight);
  });
</script>
{% endblock %}